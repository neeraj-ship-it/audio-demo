# Stage FM (AudioFlix) - Project Brain

## Project Overview
- **Name**: Stage FM / AudioFlix - Hindi Audio Stories Platform
- **Stack**: Next.js 16.1.6 + React 19, Vercel deployment, Turbopack
- **URL**: https://audio-demo-eight.vercel.app/
- **Repo**: https://github.com/neeraj-ship-it/audio-demo
- **Directory**: ~/Desktop/audio-demo/

## User Communication
- User communicates in **Hindi/Hinglish**
- Expects continuous forward progress ("age badho" = keep going)
- Wants build → commit → push → deploy cycles after each batch
- Hates repetition - once told, should be remembered forever
- Prefers practical execution over long explanations

## Architecture

### Data Storage
- **Static stories**: `data/stories.json` (deployed with app, 3 unique published stories)
- **Runtime stories**: S3 `data/stories-live.json` (generated by cron, persistent)
- **Published API**: Merges BOTH static + S3 live sources
- **Audio files**: GitHub Raw URLs (existing), S3 (new auto-generated)
- **Thumbnails**: `public/thumbnails/` (AI-generated, deployed with app)
- **Ratings**: `data/ratings.json`
- **Playlists**: `data/playlists.json`

### Key Files
- `pages/index.js` - Main app (~770 lines, uses useAudio + useUser hooks)
- `hooks/useAudio.js` - Audio state (useReducer, 13 action types)
- `hooks/useUser.js` - User state (login, favorites, history)
- `pages/api/auto-generate-story.js` - Daily cron: Gemini script → ElevenLabs audio → Gemini thumbnail → S3
- `pages/api/content/published.js` - Serves stories (static + S3 merged)
- `lib/s3-storage.js` - S3 persistent JSON storage for runtime data
- `components/ErrorBoundary.jsx` - Catches client-side React errors with stack trace display

### Env Vars (Vercel)
- `CRON_SECRET` - Cron authentication
- `GEMINI_API_KEY` - Story scripts + thumbnail generation
- `ELEVENLABS_API_KEY` - Voice/audio TTS
- `OPENAI_API_KEY` - DALL-E (billing limit reached, using Gemini instead)
- `AWS_S3_BUCKET`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION` - S3 storage
- `CLAUDE_API_KEY` - Claude API

## Content Generation SOP

### Thumbnail SOP (CRITICAL - user's strict requirement)
1. Thumbnail MUST be generated from **story script/description**, NOT just title+category
2. Extract key visual scene, characters, mood, setting from the actual story text
3. Create detailed visual prompt: characters + setting + mood + action + cultural context
4. Generate with Gemini Image API (`gemini-2.0-flash-exp-image-generation`)
5. Upload to S3 or save to `public/thumbnails/`
6. NEVER use generic stock photos - every thumbnail must visually tell the story
7. Script for manual generation: `node scripts/generate-thumbnails.js`

### Auto-Generation Pipeline (Daily Cron)
```
vercel.json cron:
├── 2:00 AM IST  → /api/auto-generate-multi-dialect (4 dialect stories)
├── 9:00 AM IST  → /api/auto-generate-story (1 random category/dialect)
└── 10:00 AM IST → /api/publish-scheduled (publish scheduled content)
```

**Flow for each story:**
1. Gemini AI generates Hindi/dialect story script (500-700 words, 5-7 min narration)
2. ElevenLabs generates voice audio (eleven_multilingual_v2 model)
3. Audio uploaded to S3 (`audio/` prefix)
4. Story description → visual scene prompt → Gemini image generation → S3 thumbnail
5. Story metadata saved to S3 `stories-live.json` (persistent across serverless restarts)
6. Published API automatically serves new stories (merges static + live)

### Content Requirements
- **Dialects**: Hindi, Bhojpuri, Gujarati, Haryanvi, Rajasthani
- **Categories**: Romance, Horror, Thriller, Comedy, Spiritual, Motivation, Culture, Family, Drama
- **Duration**: 5-15 minutes narration
- **Voice**: ElevenLabs multilingual v2, Hindi voices
- **No duplicate stories** - always check before publishing

## Completed Work (BMAD Epics)

### EPIC-1: Security & Auth
- JWT-based auth system (login/signup/logout APIs)
- Rate limiting (API: 100/min, Generation: 5/min, Auth: 10/min)
- CORS headers, input sanitization

### EPIC-2: Component Architecture
- Tailwind CSS v4 migration (globals.css)
- React Context providers (ThemeContext, ToastContext, AuthContext)
- Component extraction: HeroCarousel, AudioPlayer, MiniPlayer, SearchBar, StoryCard
- Custom hooks: useAudio (useReducer), useUser
- API client wrapper (lib/api-client.js) with retry/timeout

### EPIC-3: Accessibility
- ARIA labels across all components
- Keyboard shortcuts (Space, Arrow keys, M, Escape)
- Skip-to-content link
- Reduced motion + high contrast CSS media queries
- Focus-visible outlines, .sr-only class

### EPIC-4: User Features
- Favorites system (localStorage + API)
- History tracking (localStorage + API)
- Playlist system (PlaylistManager component + /api/playlists CRUD)

### EPIC-5: Content Pipeline (this session)
- Fixed cron endpoints (GET method for Vercel cron)
- S3 persistent storage for runtime-generated stories
- AI thumbnail generation (Gemini Image API, script-based prompts)
- Duplicate story cleanup
- Published API merges static + live sources

### EPIC-8: CI/CD
- ESLint config (.eslintrc.json)
- GitHub Actions CI (lint + build on push/PR)
- Jest + React Testing Library (26 tests)

## Known Issues / Reminders
- OpenAI billing limit reached - use Gemini for image generation
- Vercel serverless FS is ephemeral - never rely on runtime file writes
- HeroCarousel heroIndex needs bounds guard when stories array changes
- storyRatings returns {average, total} OBJECT - never render directly in JSX
- stories.json has 11 total entries but only 3 are published (have audio)
- Multi-dialect stories have pre-scripted content in multi-dialect-stories.js

## BMAD Backlog (Remaining)
- EPIC-5.2: Sound effects system
- EPIC-6.1: PostgreSQL migration (replace JSON files)
- EPIC-6.2: Redis caching
- EPIC-7.1: Analytics dashboard
- EPIC-7.2: Admin panel
- EPIC-7.3: A/B testing framework
