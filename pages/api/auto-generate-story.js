// âš¡ AUTOMATIC STORY GENERATOR
// Runs daily via Vercel cron at 9 AM IST
// Pipeline: Gemini script â†’ ElevenLabs audio â†’ S3 upload â†’ AI thumbnail â†’ S3 metadata

import { addLiveStory, uploadAudioBuffer } from '../../lib/s3-storage'

export default async function handler(req, res) {
  // Vercel cron sends GET requests
  if (req.method !== 'GET' && req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  // Security: Check cron secret (Vercel sends it automatically)
  const { authorization } = req.headers
  const cronSecret = (process.env.CRON_SECRET || '').trim()
  if (!cronSecret || authorization !== `Bearer ${cronSecret}`) {
    return res.status(401).json({ error: 'Unauthorized' })
  }

  try {
    console.log('ğŸ¤– Starting auto story generation...')

    // Pick random category and dialect (regional dialects only, no plain Hindi)
    const categories = ['Romance', 'Horror', 'Thriller', 'Comedy', 'Spiritual', 'Motivation', 'Drama', 'Culture', 'Family']
    const dialects = ['Bhojpuri', 'Gujarati', 'Haryanvi', 'Rajasthani']
    const category = categories[Math.floor(Math.random() * categories.length)]
    const dialect = dialects[Math.floor(Math.random() * dialects.length)]

    // Step 1: Generate story script with Gemini (~5s)
    console.log(`ğŸ“ Generating ${category} story in ${dialect}...`)
    const storyScript = await generateScript(category, dialect)
    console.log('âœ… Script:', storyScript.title)

    // Step 2: Generate audio with ElevenLabs â†’ upload to S3 (~30s)
    console.log('ğŸ™ï¸ Generating audio...')
    const audioUrl = await generateAndUploadAudio(storyScript.script, storyScript.title)
    console.log('âœ… Audio:', audioUrl)

    // Step 3: Thumbnail - use fallback (Gemini image gen takes ~15s, causes timeout on Hobby plan)
    const thumbnailUrl = getFallbackThumbnail(category)

    // Step 4: Save to S3 persistent storage
    const newStory = await addLiveStory({
      id: Date.now(),
      title: storyScript.title,
      description: storyScript.description,
      category,
      language: dialect,
      dialect: dialect.toLowerCase(),
      emoji: getEmoji(category),
      duration: storyScript.duration,
      audioUrl,
      audioPath: audioUrl,
      thumbnailUrl,
      generated: true,
      new: true,
      generatedAt: new Date().toISOString(),
      autoGenerated: true
    })
    console.log('âœ… Saved story:', newStory.id)

    return res.status(200).json({
      success: true,
      message: `Generated "${storyScript.title}" (${category}/${dialect})`,
      story: { id: newStory.id, title: newStory.title, category, dialect }
    })

  } catch (error) {
    console.error('âŒ Generation failed:', error)
    return res.status(500).json({ success: false, error: error.message })
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRIPT GENERATION (Google Gemini - cheaper than GPT-4)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function generateScript(category, dialect) {
  const dialectInstructions = {
    Hindi: 'simple conversational Hindi (Hinglish acceptable)',
    Bhojpuri: 'authentic Bhojpuri dialect with local expressions and flavor',
    Gujarati: 'Gujarati-Hindi mix with Gujarati cultural elements',
    Haryanvi: 'Haryanvi dialect with typical Haryanvi expressions and humor',
    Rajasthani: 'Rajasthani dialect with desert culture and royal elements'
  }

  const categoryPrompts = {
    Romance: 'a heartwarming romantic story about love and emotions',
    Horror: 'a spine-chilling horror story with suspense and mystery',
    Thriller: 'an edge-of-seat thriller with twists and suspense',
    Comedy: 'a hilarious comedy story with witty humor and funny situations',
    Spiritual: 'an inspiring spiritual story with wisdom and life lessons',
    Motivation: 'a powerful motivational story about overcoming challenges'
  }

  const prompt = `Write ${categoryPrompts[category]} in ${dialectInstructions[dialect]}.

Requirements:
- Duration: 5-7 minutes when narrated (500-700 words)
- Start with a catchy Hindi title on the first line
- Write the full narration script after the title
- Make it emotional, engaging, and natural for audio listening
- Include dialogue and character voices
- End with a satisfying conclusion
- Do NOT include any stage directions, just pure narration text`

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${process.env.GEMINI_API_KEY}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.9, maxOutputTokens: 3000 }
      })
    }
  )

  if (!response.ok) {
    const errText = await response.text()
    throw new Error(`Gemini API error: ${response.status} - ${errText}`)
  }

  const data = await response.json()
  const content = data.candidates?.[0]?.content?.parts?.[0]?.text
  if (!content) throw new Error('Gemini returned empty content')

  // Parse: first line = title, rest = script
  const lines = content.trim().split('\n').filter(l => l.trim())
  const title = lines[0].replace(/^[#*\s]+/, '').replace(/[*#]+$/, '').trim()
  const script = lines.slice(1).join('\n').trim()
  const description = script.substring(0, 200).replace(/\n/g, ' ') + '...'
  const wordCount = script.split(/\s+/).length
  const durationMin = Math.max(3, Math.round(wordCount / 100))

  return { title, script, description, duration: `${durationMin} min` }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO GENERATION (ElevenLabs â†’ S3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function generateAndUploadAudio(script, title) {
  const voiceId = process.env.DEFAULT_VOICE_ID || 'pNInz6obpgDQGcFmaJgB'

  const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
    method: 'POST',
    headers: {
      'xi-api-key': process.env.ELEVENLABS_API_KEY,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      text: script,
      model_id: 'eleven_multilingual_v2',
      voice_settings: {
        stability: 0.5,
        similarity_boost: 0.75,
        style: 0.5,
        use_speaker_boost: true
      }
    })
  })

  if (!response.ok) {
    const errText = await response.text()
    throw new Error(`ElevenLabs error: ${response.status} - ${errText}`)
  }

  const audioBuffer = Buffer.from(await response.arrayBuffer())
  const safeName = title.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 50)
  const fileName = `${Date.now()}-${safeName}.mp3`

  return uploadAudioBuffer(audioBuffer, fileName)
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI THUMBNAIL (Gemini Image Generation â†’ S3)
// SOP: Uses actual story SCRIPT to create scene-accurate prompt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function generateAIThumbnail(title, category, description) {
  // Step 1: Create visual scene prompt from story description (not just title)
  const scenePrompt = await createScenePrompt(title, category, description)

  // Step 2: Generate image with Gemini
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp-image-generation:generateContent?key=${process.env.GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: `Generate a cinematic story poster image (NO text/letters in the image): ${scenePrompt}` }]
          }],
          generationConfig: {
            responseModalities: ['IMAGE', 'TEXT'],
            responseMimeType: 'text/plain'
          }
        })
      }
    )

    if (!response.ok) throw new Error(`Gemini image error: ${response.status}`)

    const data = await response.json()
    const parts = data.candidates?.[0]?.content?.parts || []

    for (const part of parts) {
      if (part.inlineData) {
        const buffer = Buffer.from(part.inlineData.data, 'base64')
        const { uploadImageBuffer } = require('../../lib/s3-storage')
        const fileName = `${Date.now()}-${title.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 40)}.png`
        return await uploadImageBuffer(buffer, fileName)
      }
    }

    throw new Error('No image in Gemini response')
  } catch (err) {
    console.warn('Gemini thumbnail failed, using fallback:', err.message)
    return getFallbackThumbnail(category)
  }
}

// SOP: Extract visual scene from story description for accurate thumbnail
async function createScenePrompt(title, category, description) {
  const categoryStyle = {
    Romance: 'romantic Indian scene, warm colors, Bollywood style',
    Horror: 'dark spooky Indian setting, scary atmosphere',
    Thriller: 'mysterious dark scene, suspense, cinematic noir',
    Comedy: 'colorful bright Indian scene, festive, fun',
    Spiritual: 'peaceful Indian temple, divine golden light',
    Motivation: 'powerful sunrise, achievement, determination',
    Culture: 'vibrant Indian village festival, colorful traditional',
    Family: 'warm Indian family scene, emotional',
    Drama: 'dramatic cinematic Indian scene, intense'
  }

  const style = categoryStyle[category] || 'cinematic Indian story'
  // Use description (which comes from story script) to build accurate visual
  const storyContext = description ? description.substring(0, 200) : title
  return `${storyContext}, ${style}, cinematic dramatic lighting, digital painting, Bollywood movie poster quality, widescreen 16:9`
}

function getFallbackThumbnail(category) {
  const fallbacks = {
    Romance: 'https://images.unsplash.com/photo-1518199266791-5375a83190b7?w=600&h=400&fit=crop',
    Horror: 'https://images.pexels.com/photos/1616403/pexels-photo-1616403.jpeg?w=600&h=400&fit=crop',
    Thriller: 'https://images.unsplash.com/photo-1485846234645-a62644f84728?w=600&h=400&fit=crop',
    Comedy: 'https://images.unsplash.com/photo-1513151233558-d860c5398176?w=600&h=400&fit=crop',
    Spiritual: 'https://images.unsplash.com/photo-1528715471579-d1bcf0ba5e83?w=600&h=400&fit=crop',
    Motivation: 'https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=600&h=400&fit=crop',
    Culture: 'https://images.unsplash.com/photo-1513151233558-d860c5398176?w=600&h=400&fit=crop',
    Family: 'https://images.unsplash.com/photo-1528715471579-d1bcf0ba5e83?w=600&h=400&fit=crop',
    Drama: 'https://images.unsplash.com/photo-1545389336-cf090694435e?w=600&h=400&fit=crop'
  }
  return fallbacks[category] || fallbacks.Romance
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getEmoji(category) {
  return { Romance: 'ğŸ’•', Horror: 'ğŸ‘»', Thriller: 'ğŸ”ª', Comedy: 'ğŸ˜‚', Spiritual: 'ğŸ™', Motivation: 'ğŸ’ª' }[category] || 'ğŸµ'
}
