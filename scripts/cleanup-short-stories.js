#!/usr/bin/env node

/**
 * Clean up short test stories (1-19)
 * Keep only long generated stories (20+)
 */

const fs = require('fs')
const path = require('path')

const STORIES_DB = path.join(process.cwd(), 'data/stories.json')
const AUDIO_DIR = path.join(process.cwd(), 'public/audio')

console.log('ğŸ§¹ Starting cleanup of short test stories...\n')

// Read current database
const data = JSON.parse(fs.readFileSync(STORIES_DB, 'utf8'))
const allStories = data.stories

console.log(`ğŸ“Š Current total stories: ${allStories.length}`)

// Filter: Keep only long stories (ID 20+) OR stories generated by Claude
const longStories = allStories.filter(story => {
  // Keep if ID is 20 or higher (new generated stories)
  if (story.id >= 20) {
    return true
  }

  // Or if it has generatedAt timestamp from today (newly generated)
  if (story.generatedAt) {
    const genDate = new Date(story.generatedAt)
    const today = new Date()
    if (genDate.getDate() === today.getDate() &&
        genDate.getMonth() === today.getMonth() &&
        story.id >= 20) {
      return true
    }
  }

  return false
})

console.log(`âœ… Long stories to keep: ${longStories.length}`)
console.log(`âŒ Short stories to remove: ${allStories.length - longStories.length}\n`)

// List stories being removed
const removedStories = allStories.filter(s => s.id < 20)
console.log('ğŸ“‹ Removing these short test stories:')
removedStories.forEach(s => {
  console.log(`   âŒ Story ${s.id}: "${s.title}" (${s.duration})`)
})

console.log('\nğŸ“‹ Keeping these long stories:')
longStories.forEach(s => {
  console.log(`   âœ… Story ${s.id}: "${s.title}"`)
})

// Save updated database
data.stories = longStories
fs.writeFileSync(STORIES_DB, JSON.stringify(data, null, 2))
console.log(`\nâœ… Database updated: ${longStories.length} stories saved`)

// Optional: Remove old short audio files (1-19)
console.log('\nğŸ—‘ï¸  Removing old short audio files...')
let removedAudioCount = 0

for (let i = 1; i <= 19; i++) {
  const audioFile = path.join(AUDIO_DIR, `story-${i}.mp3`)
  if (fs.existsSync(audioFile)) {
    fs.unlinkSync(audioFile)
    removedAudioCount++
    console.log(`   ğŸ—‘ï¸  Removed: story-${i}.mp3`)
  }
}

console.log(`\nâœ… Removed ${removedAudioCount} old audio files`)

// Final summary
console.log('\n' + '='.repeat(50))
console.log('âœ… CLEANUP COMPLETE!')
console.log('='.repeat(50))
console.log(`\nğŸ“Š Final Statistics:`)
console.log(`   Total stories now: ${longStories.length}`)
console.log(`   Old stories removed: ${allStories.length - longStories.length}`)
console.log(`   Audio files removed: ${removedAudioCount}`)
console.log(`\nğŸ’¾ Database: ${STORIES_DB}`)
console.log(`ğŸ”Š Audio folder: ${AUDIO_DIR}`)
console.log('\nğŸ‰ Platform now has only long, complete stories!')
